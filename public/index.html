<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="description" content="PA25 Sascha — Basic HTML starter" />
    <title>PA25 Sascha</title>

    <!-- Stylesheets -->
    <link rel="stylesheet" href="styles/styles.css">

    <!-- jQuery einbinden -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <header>
        <h1>&#127828;Burgermeisterin&#127828;</h1>
    </header>   
    <main class="row">
        <div class="col-7" id="burger">
            <h4>Dein Burger:</h4>
                <div id="burger-display" class="burger-display dropZone">
                    <p class="text-sm" id="empty">Wähle zuerst deine Zutaten aus!</p>
                </div>
            <button id="reset-btn" class="btn">Zurücksetzen</button>

            <h5>Umweltbelastung deines Burgers</h5>
            <table class="table">
                <thead></thead>
                <tr>
                    <th>Kategorie</th>
                    <th>Wasserverbrauch</th>
                    <th>CO2-Verbrauch</th>
                </tr>
                </thead>
                <tbody id="ingredient-table">
                    <!-- Hier kommen die Zutaten hin und werden anschliessend berechnet-->
                </tbody>
                <tfoot>
                    <tr class="category-head">
                        <td>Total</td>
                        <td id="water-usage">0 l</td>
                        <td id="co2-emissions">0 kg</td>
                    </tr>
                </tfoot>
                
              
            </table>
        </div>
        <div class="col-5">
            <h3>Zutaten auswählen:</h3>
            <div id="ingredients-list" class="row">
                <!-- Dynamische Zutatenliste -->
                
            </div>
        </div>
    </main>
    <footer>
        <p class="text-xs">&copy; <span id="year"></span> PA25 Sascha, Daten der Items: <a href="https://foodprint.org/" class="link">Foodprint</a></p>
    </footer>

    <script src="functions.js"></script>
    <script>
        // aktuelles Jahr für Footer
        document.getElementById('year').textContent = new Date().getFullYear();
        console.log('Lade Zutaten...');

        const currentTotalCO2 = 0;
        const currentTotalWater = 0;

        // async init: lade Zutaten und initialisiere Drag&Drop
        (async function initApp() {
            try {
                await loadIngredients();

                // bind existing items (createIngredientItems already binds per-item handlers)
                const dropZone = document.querySelector('.dropZone');

                function recalcTotalsFromDropzone() {
                    const items = dropZone.querySelectorAll('.in-burger');
                    let totalCO2 = 0;
                    let totalWater = 0;
                    $('#ingredient-table').empty();
                    items.forEach(it => {
                        const name = it.getAttribute('data-name') || it.textContent || '';
                        const co2 = parseFloat(it.getAttribute('data-co2')) || 0;
                        const water = parseFloat(it.getAttribute('data-water')) || 0;
                        totalCO2 += co2;
                        totalWater += water;
                        $('#ingredient-table').append('<tr><td>' + name + '</td><td>' + water + ' l</td><td>' + co2 + ' kg</td></tr>');
                    });
                    $('#co2-emissions').text(totalCO2.toFixed(2) + ' kg');
                    $('#water-usage').text(totalWater.toFixed(0) + ' l');
                }

                // expose for item click handlers
                window.recalcTotalsFromDropzone = recalcTotalsFromDropzone;

                // Drag & Drop-Events für Drop-Zone
                // Inspo: https://dev.to/lensco825/making-a-simple-drag-and-drop-with-js-29l2
                if (dropZone) {
                    dropZone.addEventListener('dragover', e => e.preventDefault());
                    dropZone.addEventListener('dragenter', () => dropZone.classList.add('hoverover'));
                    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('hoverover'));
                    dropZone.addEventListener('drop', e => {
                        e.preventDefault();
                        const dragging = document.querySelector('.dragging');
                        if (!dragging) return;
                        dropZone.appendChild(dragging);
                        dragging.classList.remove('dragging');
                        dragging.classList.add('in-burger');

                        const name = dragging.getAttribute('data-name') || dragging.textContent || '';
                        const co2 = parseFloat(dragging.getAttribute('data-co2')) || 0;
                        const water = parseFloat(dragging.getAttribute('data-water')) || 0;

                        $('#ingredient-table').append('<tr><td>' + name + '</td><td>' + water + ' l</td><td>' + co2 + ' kg</td></tr>');
                        const currentTotalCO2 = parseFloat(document.getElementById('co2-emissions').textContent) || 0;
                        const currentTotalWater = parseFloat(document.getElementById('water-usage').textContent) || 0;
                        calculateCO2AndWater(name, co2, water, currentTotalCO2, currentTotalWater);
                    });
                }

                // Reset-Button: Bringt Ingredients zurück und leert Burger-Anzeige
                $('#reset-btn').on('click', function () {
                    const dropZone = document.querySelector('.dropZone');
                    if (dropZone) {
                        const inBurger = Array.from(dropZone.querySelectorAll('.in-burger'));
                        inBurger.forEach(it => {
                            it.classList.remove('in-burger');
                            const cat = it.getAttribute('category');
                            const container = document.getElementById(cat + '_category');
                            if (container) container.appendChild(it);
                        });
                    }

                    $('#burger-display').empty().append('<p class="text-sm" id="empty">Wähle zuerst deine Zutaten aus!</p>');
                    $('#co2-emissions').text('0 kg');
                    $('#water-usage').text('0 l');
                    $('#ingredient-table').empty();
                });

            } catch (err) {
                console.error('Init error:', err);
                const ingredientsList = document.getElementById('ingredients-list');
                if (ingredientsList) ingredientsList.innerHTML = '<div class="error">Zutaten konnten nicht geladen werden.</div>';
            }
        })();
            
        
           
    </script>
</body>
</html>